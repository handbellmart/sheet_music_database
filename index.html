<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Handbell Music Catalog</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Libre+Franklin:wght@300;400;500&display=swap');

  :root {
    --ink: #2e2c4e;
    --parchment: #eeedf5;
    --cream: #f5f4f9;
    --gold: #454369;
    --gold-light: #7c79a8;
    --rust: #2d2b52;
    --sage: #353360;
    --rule: #c8c7dc;
    --sidebar-w: 300px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Libre Franklin', sans-serif;
    background: var(--cream);
    color: var(--ink);
    min-height: 100vh;
  }

  /* â”€â”€ Header â”€â”€ */
  header {
    background: var(--ink);
    color: var(--parchment);
    padding: 28px 40px 22px;
    border-bottom: 3px solid var(--gold);
    display: flex;
    align-items: flex-end;
    gap: 24px;
  }
  header .bell-icon { font-size: 2.2rem; line-height: 1; }
  header h1 {
    font-family: 'Playfair Display', serif;
    font-size: 1.9rem;
    font-weight: 600;
    letter-spacing: 0.02em;
  }
  header p {
    font-size: 0.78rem;
    color: #a8a6c8;
    font-weight: 300;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    margin-top: 3px;
  }
  .header-text { flex: 1; }
  .result-count {
    font-size: 0.85rem;
    color: var(--gold-light);
    font-weight: 300;
    letter-spacing: 0.05em;
    align-self: center;
    white-space: nowrap;
  }

  /* â”€â”€ Layout â”€â”€ */
  .layout {
    display: flex;
    min-height: calc(100vh - 100px);
  }

  /* â”€â”€ Sidebar â”€â”€ */
  aside {
    width: var(--sidebar-w);
    min-width: var(--sidebar-w);
    background: var(--parchment);
    border-right: 1px solid var(--rule);
    padding: 0;
    overflow-y: auto;
    max-height: calc(100vh - 100px);
    position: sticky;
    top: 0;
  }

  .sidebar-header {
    padding: 18px 20px 14px;
    border-bottom: 2px solid var(--rule);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    background: var(--parchment);
    z-index: 10;
  }
  .sidebar-header span {
    font-family: 'Playfair Display', serif;
    font-size: 1rem;
    font-style: italic;
    color: var(--gold);
  }
  .clear-btn {
    font-size: 0.7rem;
    font-family: 'Libre Franklin', sans-serif;
    font-weight: 500;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: var(--rust);
    background: none;
    border: 1px solid var(--rust);
    padding: 3px 8px;
    cursor: pointer;
    border-radius: 2px;
    transition: all 0.15s;
  }
  .clear-btn:hover { background: var(--rust); color: white; }

  .filter-group {
    border-bottom: 1px solid var(--rule);
  }
  .filter-group-header {
    padding: 11px 20px;
    font-size: 0.68rem;
    font-weight: 500;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: #7c79a8;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    user-select: none;
    transition: background 0.1s;
  }
  .filter-group-header:hover { background: #dddcee; }
  .filter-group-header .arrow {
    font-size: 0.6rem;
    color: var(--gold);
    transition: transform 0.2s;
  }
  .filter-group-header.open .arrow { transform: rotate(180deg); }
  .filter-group-body {
    display: none;
    padding: 8px 20px 12px;
    background: #f5f4f9;
    max-height: 200px;
    overflow-y: auto;
  }
  .filter-group-body.open { display: block; }
  .filter-group-body label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.8rem;
    font-weight: 300;
    padding: 3px 0;
    cursor: pointer;
    color: #35335a;
    transition: color 0.1s;
  }
  .filter-group-body label:hover { color: var(--gold); }
  .filter-group-body input[type=checkbox] {
    accent-color: var(--gold);
    width: 13px; height: 13px;
    cursor: pointer;
    flex-shrink: 0;
  }
  .filter-group-body .count {
    margin-left: auto;
    font-size: 0.68rem;
    color: #a8a6c8;
    font-weight: 300;
  }

  /* â”€â”€ Main content â”€â”€ */
  main {
    flex: 1;
    padding: 24px 32px;
    overflow-x: auto;
  }

  /* â”€â”€ Upload zone â”€â”€ */
  .upload-zone {
    border: 2px dashed var(--rule);
    border-radius: 4px;
    padding: 40px;
    text-align: center;
    margin-bottom: 24px;
    background: #f0eff7;
    transition: border-color 0.2s;
  }
  .upload-zone:hover { border-color: var(--gold); }
  .upload-zone h2 {
    font-family: 'Playfair Display', serif;
    font-size: 1.3rem;
    font-weight: 400;
    font-style: italic;
    color: var(--gold);
    margin-bottom: 8px;
  }
  .upload-zone p { font-size: 0.82rem; color: #7c79a8; font-weight: 300; margin-bottom: 18px; }
  .upload-btn {
    display: inline-block;
    background: var(--ink);
    color: var(--parchment);
    padding: 10px 24px;
    font-family: 'Libre Franklin', sans-serif;
    font-size: 0.78rem;
    font-weight: 500;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    cursor: pointer;
    border: none;
    border-radius: 2px;
    transition: background 0.15s;
  }
  .upload-btn:hover { background: var(--rust); }
  #file-input { display: none; }
  .sample-btn {
    display: inline-block;
    margin-left: 12px;
    background: none;
    color: var(--gold);
    padding: 10px 20px;
    font-family: 'Libre Franklin', sans-serif;
    font-size: 0.78rem;
    font-weight: 500;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    cursor: pointer;
    border: 1px solid var(--gold);
    border-radius: 2px;
    transition: all 0.15s;
  }
  .sample-btn:hover { background: var(--gold); color: white; }

  /* â”€â”€ Search bar â”€â”€ */
  .search-bar {
    margin-bottom: 20px;
    display: flex;
    gap: 10px;
    align-items: center;
  }
  .search-bar input {
    flex: 1;
    border: 1px solid var(--rule);
    background: white;
    padding: 9px 14px;
    font-family: 'Libre Franklin', sans-serif;
    font-size: 0.85rem;
    font-weight: 300;
    color: var(--ink);
    border-radius: 2px;
    outline: none;
    transition: border-color 0.15s;
  }
  .search-bar input:focus { border-color: var(--gold); }
  .search-bar input::placeholder { color: #a8a6c8; }

  /* â”€â”€ Table â”€â”€ */
  .table-wrap { overflow-x: auto; }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.8rem;
    min-width: 900px;
  }
  thead tr {
    background: var(--ink);
    color: var(--parchment);
  }
  th {
    padding: 10px 12px;
    text-align: left;
    font-weight: 500;
    font-size: 0.68rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    white-space: nowrap;
    cursor: pointer;
    user-select: none;
  }
  th:hover { background: #3a3860; }
  th.sorted-asc::after { content: ' â–²'; color: var(--gold-light); font-size: 0.6rem; }
  th.sorted-desc::after { content: ' â–¼'; color: var(--gold-light); font-size: 0.6rem; }

  tbody tr {
    border-bottom: 1px solid var(--rule);
    transition: background 0.1s;
  }
  tbody tr:nth-child(even) { background: #f0eff7; }
  tbody tr:hover { background: #dddcee; }
  td {
    padding: 9px 12px;
    vertical-align: top;
    color: #2e2c4e;
    font-weight: 300;
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  td.title-col {
    font-family: 'Playfair Display', serif;
    font-style: italic;
    font-size: 0.85rem;
    font-weight: 400;
    color: var(--ink);
    white-space: normal;
    min-width: 180px;
  }
  td a {
    color: var(--gold);
    text-decoration: none;
    font-size: 0.75rem;
  }
  td a:hover { text-decoration: underline; }

  .badge {
    display: inline-block;
    background: var(--parchment);
    border: 1px solid var(--rule);
    color: #454369;
    font-size: 0.65rem;
    padding: 1px 6px;
    border-radius: 10px;
    white-space: nowrap;
    font-weight: 400;
  }

  .empty-state {
    text-align: center;
    padding: 60px;
    color: #a8a6c8;
  }
  .empty-state h3 {
    font-family: 'Playfair Display', serif;
    font-style: italic;
    font-size: 1.4rem;
    font-weight: 400;
    margin-bottom: 8px;
  }
  .empty-state p { font-size: 0.82rem; font-weight: 300; }

  /* â”€â”€ Column toggle button â”€â”€ */
  .col-toggle-btn {
    background: none;
    border: 1px solid #2d2b52;
    color: var(--parchment);
    font-family: 'Libre Franklin', sans-serif;
    font-size: 0.75rem;
    font-weight: 400;
    letter-spacing: 0.06em;
    padding: 5px 12px;
    cursor: pointer;
    border-radius: 2px;
    transition: all 0.15s;
    white-space: nowrap;
    align-self: center;
  }
  .col-toggle-btn:hover { background: #35335a; border-color: var(--gold); color: var(--gold-light); }

  /* â”€â”€ Column panel â”€â”€ */
  #col-panel {
    background: var(--parchment);
    border-bottom: 2px solid var(--rule);
    padding: 0;
  }
  .col-panel-inner { max-width: 100%; }
  .col-panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 20px;
    background: #dddcee;
    border-bottom: 1px solid var(--rule);
    font-family: 'Playfair Display', serif;
    font-style: italic;
    font-size: 0.95rem;
    color: var(--gold);
  }
  .col-action-btn {
    font-family: 'Libre Franklin', sans-serif;
    font-size: 0.68rem;
    font-weight: 500;
    letter-spacing: 0.07em;
    text-transform: uppercase;
    background: none;
    border: 1px solid var(--rule);
    color: #454369;
    padding: 3px 9px;
    cursor: pointer;
    border-radius: 2px;
    transition: all 0.15s;
  }
  .col-action-btn:hover { background: var(--ink); color: var(--parchment); border-color: var(--ink); }
  .col-close { border-color: var(--rust); color: var(--rust); }
  .col-close:hover { background: var(--rust); color: white; border-color: var(--rust); }
  .col-panel-body {
    display: flex;
    flex-wrap: wrap;
    gap: 6px 12px;
    padding: 12px 20px;
  }
  .col-panel-body label {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.78rem;
    font-weight: 300;
    cursor: pointer;
    color: #35335a;
    white-space: nowrap;
    padding: 3px 8px;
    border: 1px solid var(--rule);
    border-radius: 2px;
    background: white;
    transition: all 0.1s;
  }
  .col-panel-body label:hover { border-color: var(--gold); color: var(--gold); }
  .col-panel-body input[type=checkbox] { accent-color: var(--gold); cursor: pointer; }

  /* scrollbar styling */
  aside::-webkit-scrollbar,
  .filter-group-body::-webkit-scrollbar { width: 4px; }
  aside::-webkit-scrollbar-track,
  .filter-group-body::-webkit-scrollbar-track { background: transparent; }
  aside::-webkit-scrollbar-thumb { background: var(--rule); border-radius: 2px; }

  /* â”€â”€ Boolean Yes/No toggle â”€â”€ */
  .bool-toggle {
    display: flex;
    gap: 8px;
    padding: 6px 0 4px;
  }
  .bool-btn {
    flex: 1;
    padding: 5px 0;
    font-family: 'Libre Franklin', sans-serif;
    font-size: 0.75rem;
    font-weight: 500;
    letter-spacing: 0.05em;
    border-radius: 3px;
    cursor: pointer;
    border: 1.5px solid #c8c7dc;
    background: white;
    color: #a8a6c8;
    transition: all 0.15s;
  }
  .bool-btn:hover { border-color: var(--gold); color: var(--gold); }
  .bool-btn[data-state="yes"] { background: var(--gold); border-color: var(--gold); color: white; }
  .bool-btn[data-state="no"]  { background: #c0392b; border-color: #c0392b; color: white; }

  /* â”€â”€ Tri-state filter buttons â”€â”€ */
  .filter-group-body label {
    display: flex;
    align-items: center;
    gap: 0;
    font-size: 0.8rem;
    font-weight: 300;
    padding: 0;
    cursor: default;
    color: #35335a;
  }
  .filter-group-body label:hover { color: #35335a; border: none; background: none; }
  .tri-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    border: 1.5px solid #c8c7dc;
    background: white;
    cursor: pointer;
    font-size: 0.7rem;
    font-weight: 700;
    flex-shrink: 0;
    transition: all 0.15s;
    user-select: none;
    margin-right: 7px;
  }
  .tri-btn[data-state="yes"] {
    background: var(--gold);
    border-color: var(--gold);
    color: white;
  }
  .tri-btn[data-state="no"] {
    background: #c0392b;
    border-color: #c0392b;
    color: white;
  }
  .tri-btn[data-state="dc"] {
    background: white;
    border-color: #c8c7dc;
    color: #a8a6c8;
  }
  .tri-btn:hover { border-color: var(--gold); }
  .filter-item {
    display: flex;
    align-items: center;
    padding: 3px 0;
    width: 100%;
  }
  .filter-item-label { flex: 1; font-size: 0.8rem; font-weight: 300; color: #35335a; }
  .filter-item-count { font-size: 0.68rem; color: #a8a6c8; font-weight: 300; margin-left: 4px; }

  /* â”€â”€ Pill colours for yes/no â”€â”€ */
  .pill-yes { background: var(--ink); }
  .pill-no  { background: #c0392b; }

  /* Active filter pills */
  .active-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 14px;
  }
  .pill {
    display: flex;
    align-items: center;
    gap: 5px;
    background: var(--ink);
    color: var(--parchment);
    font-size: 0.7rem;
    font-weight: 400;
    padding: 3px 9px 3px 9px;
    border-radius: 20px;
    letter-spacing: 0.02em;
  }
  .pill .remove {
    cursor: pointer;
    color: #a8a6c8;
    font-size: 0.75rem;
    line-height: 1;
    transition: color 0.1s;
  }
  .pill .remove:hover { color: var(--gold-light); }
  .pill .field { color: var(--gold-light); margin-right: 2px; }
</style>
</head>
<body>

<header>
  <div class="bell-icon">ðŸ””</div>
  <div class="header-text">
    <h1>Handbell Music Catalog</h1>
    <p>Search &amp; Filter Your Library</p>
  </div>
  <div class="result-count" id="result-count"></div>
  <button class="col-toggle-btn" onclick="toggleColPanel()">âŠž Columns</button>
</header>

<div class="layout">
  <aside id="sidebar">
    <div class="sidebar-header">
      <span>Filters</span>
      <button class="clear-btn" onclick="clearAllFilters()">Clear All</button>
    </div>
    <div id="filter-groups"></div>
  </aside>

  <main>
    <div class="upload-zone" id="upload-zone">
      <h2>Loading Catalogâ€¦</h2>
      <p>Fetching the handbell music catalog, please wait.</p>
    </div>

    <div id="col-panel" style="display:none">
      <div class="col-panel-inner">
        <div class="col-panel-header">
          <span>Show / Hide Columns</span>
          <div style="display:flex;gap:8px;">
            <button class="col-action-btn" onclick="setAllCols(true)">All</button>
            <button class="col-action-btn" onclick="setAllCols(false)">None</button>
            <button class="col-action-btn" onclick="resetCols()">Reset</button>
            <button class="col-action-btn col-close" onclick="toggleColPanel()">âœ• Close</button>
          </div>
        </div>
        <div class="col-panel-body" id="col-checkboxes"></div>
      </div>
    </div>

    <div id="search-area" style="display:none">
      <div class="search-bar">
        <input type="text" id="text-search" placeholder="Search by title, composer, arranger, HM codeâ€¦" oninput="applyFilters()">
      </div>
      <div class="active-filters" id="active-filters"></div>
    </div>

    <div class="table-wrap">
      <table id="results-table" style="display:none">
        <thead id="table-head"></thead>
        <tbody id="table-body"></tbody>
      </table>
      <div class="empty-state" id="empty-state" style="display:none">
        <h3>No results found</h3>
        <p>Try adjusting your filters or search terms.</p>
      </div>
    </div>
  </main>
</div>

<script>
// â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const FILTER_COLS = [
  'Publisher','Type','Composer','Arranger','Level',
  'Octaves of bells','Octaves of chimes',
  'Key signature changes','Accidentals','Key signature(s)',
  'Time signature changes','Time signature(s)',
  'Notes','Repeats','Techniques','Number of pages'
];

const BOOLEAN_COLS = ['Key signature changes','Accidentals','Time signature changes','Repeats'];

const DISPLAY_COLS = [
  'HM Code','HM Title','HM Alternate Title','Arrangement of',
  'Composer','Arranger','Publisher','Type','Level',
  'Octaves of bells','Octaves of chimes','Occasion',
  'Duration','Key signature(s)','Time signature(s)',
  'Techniques','Link to buy','Link to listen/view'
];

const DEFAULT_COLS = [
  'HM Title','Arrangement of','Composer','Arranger',
  'Level','Octaves of bells','Octaves of chimes',
  'Key signature(s)'
];

let visibleCols = [...DEFAULT_COLS];

const TEXT_SEARCH_COLS = ['HM Code','HM Title','HM Alternate Title','Composer','Arranger','Arrangement of'];

// â”€â”€ Parse duration to seconds (handles plain numbers, m:ss, mm:ss) â”€â”€
function parseDuration(val) {
  if (!val && val !== 0) return NaN;
  const s = String(val).trim();
  // mm:ss or m:ss format
  const colonMatch = s.match(/^(\d+):(\d{2})$/);
  if (colonMatch) return parseInt(colonMatch[1]) * 60 + parseInt(colonMatch[2]);
  // plain number (already seconds)
  const n = parseFloat(s);
  return isNaN(n) ? NaN : n;
}

// â”€â”€ Duration range buckets (in seconds) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DURATION_BUCKETS = [
  { label: '< 1 min',   min: 0,   max: 60   },
  { label: '1-2 min',   min: 60,  max: 120  },
  { label: '2-3 min',   min: 120, max: 180  },
  { label: '3-4 min',   min: 180, max: 240  },
  { label: '4-5 min',   min: 240, max: 300  },
  { label: '5-6 min',   min: 300, max: 360  },
  { label: '6-7 min',   min: 360, max: 420  },
  { label: '7-8 min',   min: 420, max: 480  },
  { label: '8-9 min',   min: 480, max: 540  },
  { label: '9-10 min',  min: 540, max: 600  },
  { label: '10+ min',   min: 600, max: Infinity },
];

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let allData = [];
let filters = {}; // { col: { value: 'yes'|'no' } } â€” 'dc' (don't care) means absent
let sortCol = null;
let sortDir = 1;

// â”€â”€ Auto-load from Google Drive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const GDRIVE_URL = 'https://handbellmart.github.io/sheet_music_database/database.csv';

function loadFromGDrive() {
  Papa.parse(GDRIVE_URL, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: r => initData(r.data),
    error: function(err) {
      var zone = document.getElementById('upload-zone');
      zone.innerHTML = '<h2>Could Not Load Catalog</h2><p>The file could not be fetched. This is usually a CORS restriction when opening locally. Host this file on a web server and ensure the Google Drive file is shared publicly.</p>';
    }
  });
}

window.addEventListener('DOMContentLoaded', loadFromGDrive);


// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initData(data) {
  allData = data;
  filters = {};
  document.getElementById('upload-zone').style.display = 'none';
  document.getElementById('search-area').style.display = 'block';
  document.getElementById('results-table').style.display = 'table';
  visibleCols = [...DEFAULT_COLS];
  buildTableHeader();
  buildColPanel();
  buildFilterSidebar();
  applyFilters();
}

// â”€â”€ Table Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildTableHeader() {
  const head = document.getElementById('table-head');
  const available = visibleCols.filter(c => allData[0] && c in allData[0]);
  head.innerHTML = '<tr>' + available.map(col =>
    `<th onclick="sortBy('${col}')" data-col="${col}">${col}</th>`
  ).join('') + '</tr>';
}

function buildColPanel() {
  const container = document.getElementById('col-checkboxes');
  container.innerHTML = DISPLAY_COLS
    .filter(c => allData[0] && c in allData[0])
    .map(col => `
      <label>
        <input type="checkbox" ${visibleCols.includes(col) ? 'checked' : ''}
          onchange="toggleCol('${col}', this.checked)">
        ${col}
      </label>`).join('');
}

function toggleColPanel() {
  const panel = document.getElementById('col-panel');
  panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}

function toggleCol(col, show) {
  if (show && !visibleCols.includes(col)) visibleCols.push(col);
  else if (!show) visibleCols = visibleCols.filter(c => c !== col);
  // preserve DISPLAY_COLS order
  visibleCols.sort((a,b) => DISPLAY_COLS.indexOf(a) - DISPLAY_COLS.indexOf(b));
  buildTableHeader();
  applyFilters();
}

function setAllCols(show) {
  visibleCols = show ? [...DISPLAY_COLS].filter(c => allData[0] && c in allData[0]) : [];
  buildColPanel();
  buildTableHeader();
  applyFilters();
}

function resetCols() {
  visibleCols = [...DEFAULT_COLS];
  buildColPanel();
  buildTableHeader();
  applyFilters();
}

// â”€â”€ Helper: split a cell value by comma into trimmed tokens â”€â”€
function splitCell(val) {
  return String(val).split(',').map(s => s.trim()).filter(Boolean);
}

// â”€â”€ Filter Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildFilterSidebar() {
  const container = document.getElementById('filter-groups');
  container.innerHTML = '';
  const available = FILTER_COLS.filter(c => allData[0] && c in allData[0]);
  available.forEach(col => {
    const values = [...new Set(
      allData.flatMap(r => splitCell(r[col] || '')).filter(Boolean)
    )].sort((a, b) => {
      const na = parseFloat(a), nb = parseFloat(b);
      if (!isNaN(na) && !isNaN(nb)) return na - nb;
      return a.localeCompare(b);
    });
    if (values.length < 2) return;
    const group = document.createElement('div');
    group.className = 'filter-group';
    const bodyId = 'fg-' + col.replace(/[^a-z0-9]/gi, '_');
    const isBoolean = BOOLEAN_COLS.includes(col);
    group.innerHTML = `
      <div class="filter-group-header" onclick="toggleGroup(this)">
        <span>${col}</span><span class="arrow">â–¾</span>
      </div>
      <div class="filter-group-body" id="${bodyId}">
        ${isBoolean ? `
        <div class="filter-item">
          <span class="tri-btn" data-state="dc" data-col="${escHtml(col)}" data-val="__bool__" onclick="cycleBoolSingle(this)">â€“</span>
          <span class="filter-item-label" id="bool-label-${escHtml(col)}">Don't Care</span>
        </div>` :
        values.map(v => {
          const count = allData.filter(r => splitCell(r[col]||'').includes(v)).length;
          return `<div class="filter-item">
            <span class="tri-btn" data-state="dc" data-col="${escHtml(col)}" data-val="${escHtml(v)}" onclick="cycleFilter(this)">â€“</span>
            <span class="filter-item-label">${escHtml(v)}</span>
            <span class="filter-item-count">${count}</span>
          </div>`;
        }).join('')}
      </div>`;
    container.appendChild(group);
  });

  // â”€â”€ Duration range filter group â”€â”€
  if (allData[0] && 'Duration' in allData[0]) {
    const durationGroup = document.createElement('div');
    durationGroup.className = 'filter-group';
    durationGroup.innerHTML = `
      <div class="filter-group-header" onclick="toggleGroup(this)">
        <span>Duration</span><span class="arrow">â–¾</span>
      </div>
      <div class="filter-group-body">
        ${DURATION_BUCKETS.map(b => {
          const count = allData.filter(r => {
            const s = parseDuration(r['Duration']);
            return !isNaN(s) && s >= b.min && s < b.max;
          }).length;
          return `<div class="filter-item">
            <span class="tri-btn" data-state="dc" data-col="__duration__" data-val="${escHtml(b.label)}" onclick="cycleFilter(this)">â€“</span>
            <span class="filter-item-label">${escHtml(b.label)}</span>
            <span class="filter-item-count">${count}</span>
          </div>`;
        }).join('')}
      </div>`;
    container.appendChild(durationGroup);
  }
}

function toggleGroup(header) {
  header.classList.toggle('open');
  header.nextElementSibling.classList.toggle('open');
}

// â”€â”€ Tri-state filter cycle: dc â†’ yes â†’ no â†’ dc â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function cycleFilter(btn) {
  const col = btn.dataset.col;
  const val = btn.dataset.val;
  const current = btn.dataset.state;
  const next = current === 'dc' ? 'yes' : current === 'yes' ? 'no' : 'dc';
  btn.dataset.state = next;
  btn.textContent = next === 'yes' ? 'âœ“' : next === 'no' ? 'âœ•' : 'â€“';

  if (!filters[col]) filters[col] = {};
  if (next === 'dc') {
    delete filters[col][val];
    if (Object.keys(filters[col]).length === 0) delete filters[col];
  } else {
    filters[col][val] = next;
  }
  renderPills();
  applyFilters();
}

// â”€â”€ Boolean single tri-state button: dc â†’ yes â†’ no â†’ dc â”€â”€
function cycleBoolSingle(btn) {
  const col = btn.dataset.col;
  const current = btn.dataset.state;
  const next = current === 'dc' ? 'yes' : current === 'yes' ? 'no' : 'dc';
  btn.dataset.state = next;
  btn.textContent = next === 'yes' ? 'âœ“' : next === 'no' ? 'âœ•' : 'â€“';

  // Update the label text
  const label = document.getElementById('bool-label-' + col);
  if (label) label.textContent = next === 'yes' ? 'Yes' : next === 'no' ? 'No' : "Don't Care";

  if (!filters[col]) filters[col] = {};
  if (next === 'dc') {
    delete filters[col];
  } else {
    // Store as yesâ†’'Yes', noâ†’'No' so applyFilters can match cell values
    filters[col] = { [next === 'yes' ? 'Yes' : 'No']: next };
  }
  renderPills();
  applyFilters();
}

function clearAllFilters() {
  filters = {};
  document.querySelectorAll('.tri-btn').forEach(btn => {
    btn.dataset.state = 'dc';
    btn.textContent = 'â€“';
  });
  document.querySelectorAll('.tri-btn[data-val="__bool__"]').forEach(btn => {
    btn.dataset.state = 'dc';
    btn.textContent = 'â€“';
    const label = document.getElementById('bool-label-' + btn.dataset.col);
    if (label) label.textContent = "Don't Care";
  });
  document.getElementById('text-search').value = '';
  renderPills();
  applyFilters();
}

function renderPills() {
  const container = document.getElementById('active-filters');
  container.innerHTML = '';
  Object.entries(filters).forEach(([col, valMap]) => {
    const displayCol = col === '__duration__' ? 'Duration' : col;
    Object.entries(valMap).forEach(([val, state]) => {
      const pill = document.createElement('div');
      pill.className = 'pill ' + (state === 'yes' ? 'pill-yes' : 'pill-no');
      const icon = state === 'yes' ? 'âœ“' : 'âœ•';
      pill.innerHTML = `<span style="opacity:0.7;font-size:0.65rem;">${icon}</span> <span class="field">${escHtml(displayCol)}:</span> ${escHtml(val)} <span class="remove" onclick="removeTri('${escJs(col)}','${escJs(val)}')">âœ•</span>`;
      container.appendChild(pill);
    });
  });
}

function removeTri(col, val) {
  if (filters[col]) {
    delete filters[col][val];
    if (Object.keys(filters[col]).length === 0) delete filters[col];
  }
  // Reset tri-state button if present
  const triBtn = document.querySelector(`.tri-btn[data-col="${col}"][data-val="${val}"]`);
  if (triBtn) { triBtn.dataset.state = 'dc'; triBtn.textContent = 'â€“'; }
  // Reset single bool button if present
  const boolBtn = document.querySelector(`.tri-btn[data-col="${col}"][data-val="__bool__"]`);
  if (boolBtn) {
    boolBtn.dataset.state = 'dc';
    boolBtn.textContent = 'â€“';
    const label = document.getElementById('bool-label-' + col);
    if (label) label.textContent = "Don't Care";
  }
  renderPills();
  applyFilters();
}

// â”€â”€ Filtering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyFilters() {
  const query = (document.getElementById('text-search').value || '').toLowerCase().trim();
  let rows = allData;

  // Tri-state filters: each active filter entry is { val: 'yes'|'no' }
  // YES values: row must contain AT LEAST ONE yes-value in that column
  // NO values:  row must NOT contain ANY no-value in that column
  // Duration uses special bucket matching via __duration__ key
  Object.entries(filters).forEach(([col, valMap]) => {
    const yesVals = Object.entries(valMap).filter(([,s]) => s === 'yes').map(([v]) => v);
    const noVals  = Object.entries(valMap).filter(([,s]) => s === 'no').map(([v]) => v);

    if (col === '__duration__') {
      // YES: row must fall in at least one yes bucket
      if (yesVals.length > 0) {
        const yesBuckets = DURATION_BUCKETS.filter(b => yesVals.includes(b.label));
        rows = rows.filter(r => {
          const s = parseDuration(r['Duration']);
          return !isNaN(s) && yesBuckets.some(b => s >= b.min && s < b.max);
        });
      }
      // NO: row must not fall in any no bucket
      if (noVals.length > 0) {
        const noBuckets = DURATION_BUCKETS.filter(b => noVals.includes(b.label));
        rows = rows.filter(r => {
          const s = parseDuration(r['Duration']);
          return isNaN(s) || !noBuckets.some(b => s >= b.min && s < b.max);
        });
      }
      return;
    }

    // Regular columns
    if (yesVals.length > 0) {
      rows = rows.filter(r => yesVals.every(v => splitCell(r[col] || '').includes(v)));
    }
    if (noVals.length > 0) {
      rows = rows.filter(r => !noVals.some(v => splitCell(r[col] || '').includes(v)));
    }
  });

  // text search
  if (query) {
    rows = rows.filter(r =>
      TEXT_SEARCH_COLS.some(c => (r[c]||'').toLowerCase().includes(query))
    );
  }

  // sort
  if (sortCol) {
    rows = [...rows].sort((a,b) => {
      // Sort Duration numerically (stored as seconds)
      if (sortCol === 'Duration') {
        const an = parseFloat(a[sortCol]) || 0;
        const bn = parseFloat(b[sortCol]) || 0;
        return (an - bn) * sortDir;
      }
      const av = (a[sortCol]||'').toLowerCase();
      const bv = (b[sortCol]||'').toLowerCase();
      return av < bv ? -sortDir : av > bv ? sortDir : 0;
    });
  }

  renderTable(rows);
  document.getElementById('result-count').textContent =
    `${rows.length} of ${allData.length} piece${allData.length !== 1 ? 's' : ''}`;
}

// â”€â”€ Table Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTable(rows) {
  const available = visibleCols.filter(c => allData[0] && c in allData[0]);
  const tbody = document.getElementById('table-body');
  const empty = document.getElementById('empty-state');
  if (rows.length === 0) {
    tbody.innerHTML = '';
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';
  tbody.innerHTML = rows.map(row =>
    '<tr>' + available.map(col => {
      const val = row[col] || '';
      if (col === 'HM Title') { const link = row['Link to buy']; return link ? `<td class="title-col"><a href="${escHtml(link)}" target="_blank" style="color:inherit;text-decoration:underline;text-decoration-color:var(--gold);text-underline-offset:3px;">${escHtml(val)}</a></td>` : `<td class="title-col">${escHtml(val)}</td>`; }
      if (col === 'HM Alternate Title') return `<td class="title-col">${escHtml(val)}</td>`;
      if (col === 'Link to buy' && val) return `<td><a href="${escHtml(val)}" target="_blank">Buy â†—</a></td>`;
      if (col === 'Link to listen/view' && val) return `<td><a href="${escHtml(val)}" target="_blank">Listen â†—</a></td>`;
      if (col === 'Duration' && val) {
        const secs = parseFloat(val);
        if (!isNaN(secs)) {
          const m = Math.floor(secs / 60);
          const s = Math.floor(secs % 60);
          const formatted = m + ':' + String(s).padStart(2, '0');
          return `<td>${formatted}</td>`;
        }
      }
      if (['Techniques','Occasion'].includes(col) && val) return `<td><span class="badge">${escHtml(val)}</span></td>`;
      return `<td title="${escHtml(val)}">${escHtml(val)}</td>`;
    }).join('') + '</tr>'
  ).join('');
}

// â”€â”€ Sorting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sortBy(col) {
  if (sortCol === col) sortDir *= -1;
  else { sortCol = col; sortDir = 1; }
  document.querySelectorAll('th').forEach(th => {
    th.classList.remove('sorted-asc','sorted-desc');
    if (th.dataset.col === col) th.classList.add(sortDir === 1 ? 'sorted-asc' : 'sorted-desc');
  });
  applyFilters();
}

// â”€â”€ Utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function escJs(s) {
  return String(s).replace(/'/g,"\\'");
}
</script>
</body>
</html>

